{% extends "base.html" %}

{% block title %}Reports - Biometric Attendance System{% endblock %}

{% block content %}
<h2 class="section-title">Attendance Reports</h2>

<div class="filter-section">
    <div class="form-group">
        <label for="start_date">Start Date</label>
        <input type="date" id="start_date">
    </div>

    <div class="form-group">
        <label for="end_date">End Date</label>
        <input type="date" id="end_date">
    </div>

    <div class="form-group">
        <label for="class_filter">Class</label>
        <select id="class_filter">
            <option value="">All Classes</option>
            <option value="FY">First Year</option>
            <option value="SY">Second Year</option>
            <option value="TY">Third Year</option>
        </select>
    </div>

    <div class="form-group" style="display: flex; align-items: flex-end; gap: 0.5rem;">
        <button id="filterBtn" class="btn btn-primary">Filter</button>
        <button id="exportCsvBtn" class="btn btn-secondary">Export CSV</button>
        <button id="exportExcelBtn" class="btn btn-secondary">Export Excel</button>
    </div>
</div>

<div class="table-container" style="overflow-x: auto;">
    <table class="data-table">
        <thead>
            <tr>
                <th>Date</th>
                <th>Time</th>
                <th>Lecture</th>
                <th>Student Name</th>
                <th>Enrollment</th>
                <th>Class</th>
                <th>Status</th>
                <th>Faculty</th>
            </tr>
        </thead>
        <tbody id="report-data">
            <!-- Data will be loaded here via JS -->
            <tr>
                <td colspan="8" style="text-align: center; color: #666;">Select filters and click "Filter" to view data.
                </td>
            </tr>
        </tbody>
    </table>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const filterBtn = document.getElementById('filterBtn');
        const exportCsvBtn = document.getElementById('exportCsvBtn');
        const exportExcelBtn = document.getElementById('exportExcelBtn');

        filterBtn.addEventListener('click', loadData);

        exportCsvBtn.addEventListener('click', function () {
            exportData('csv');
        });

        exportExcelBtn.addEventListener('click', function () {
            exportData('excel');
        });

        function getFilters() {
            return {
                start_date: document.getElementById('start_date').value,
                end_date: document.getElementById('end_date').value,
                class_name: document.getElementById('class_filter').value
            };
        }

        function loadData() {
            const filters = getFilters();
            const queryParams = new URLSearchParams(filters).toString();

            document.getElementById('report-data').innerHTML = '<tr><td colspan="8" style="text-align: center;">Loading...</td></tr>';

            fetch(`/api/get_attendance?${queryParams}`)
                .then(response => response.json())
                .then(data => {
                    const tbody = document.getElementById('report-data');
                    tbody.innerHTML = '';

                    if (data.success && data.data.length > 0) {
                        data.data.forEach(record => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${record.date}</td>
                                <td>${record.time}</td>
                                <td>${record.lecture_number}</td>
                                <td>${record.student_name}</td>
                                <td>${record.enrollment_number}</td>
                                <td>${record.class_name}</td>
                                <td><span class="badge badge-success">${record.status}</span></td>
                                <td>${record.faculty_name}</td>
                            `;
                            tbody.appendChild(row);
                        });
                    } else {
                        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">No records found.</td></tr>';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('report-data').innerHTML = '<tr><td colspan="8" style="text-align: center; color: red;">Error loading data</td></tr>';
                });
        }

        function exportData(format) {
            const filters = getFilters();
            filters.format = format;
            const queryParams = new URLSearchParams(filters).toString();
            window.location.href = `/api/export_attendance?${queryParams}`;
        }
    });
</script>
{% endblock %}