{% extends "base.html" %}

{% block title %}Manual Attendance{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h2 class="section-title">Manual Attendance Entry</h2>
        <p style="color: var(--text-muted); margin-top: 0.25rem;">Use this when face recognition is not available.</p>
    </div>
</div>

<form method="GET" class="card" style="margin-bottom: 1.5rem; padding: 1.25rem 1.5rem;">
    <div class="form-group" style="max-width: 260px; margin-bottom: 0;">
        <label class="form-label">Select Class</label>
        <select name="class_name" class="form-control" onchange="this.form.submit()">
            <option value="">-- Choose --</option>
            <option value="FY" {{ 'selected' if class_name=='FY' else '' }}>FY</option>
            <option value="SY" {{ 'selected' if class_name=='SY' else '' }}>SY</option>
            <option value="TY" {{ 'selected' if class_name=='TY' else '' }}>TY</option>
        </select>
    </div>
</form>

{% if class_name %}
<div class="card">
    <div class="card-header">
        <h3 class="card-title"><i class="fas fa-users"></i> Mark Attendance for {{ class_name }}</h3>
    </div>
    <div class="table-container">
        <table class="data-table">
        <thead>
            <tr>
                <th>Student</th>
                <th>Subject</th>
                <th>Status</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for student in students %}
            <tr>
                <td>
                    <strong>{{ student.name }}</strong><br>
                    <small style="color: var(--text-muted);">{{ student.enrollment_number }}</small>
                </td>
                <form method="POST" action="{{ url_for('manual_attendance') }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="class_name" value="{{ class_name }}">
                    <input type="hidden" name="student_id" value="{{ student.student_id }}">
                    <td>
                        <select name="subject_id" class="subject-select form-control" required>
                            <!-- Loaded via JS -->
                            <option>Loading...</option>
                        </select>
                    </td>
                    <td>
                        <select name="status" class="form-control">
                            <option value="Present">Present</option>
                            <option value="Absent">Absent</option>
                            <option value="Late">Late</option>
                        </select>
                    </td>
                    <td>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-check"></i> Mark
                        </button>
                    </td>
                </form>
            </tr>
            {% endfor %}
        </tbody>
        </table>
    </div>
</div>

<script>
    // Load subjects for all dropdowns
    document.addEventListener('DOMContentLoaded', function () {
        fetch('/api/get_subjects/{{ class_name }}')
            .then(res => res.json())
            .then(data => {
                document.querySelectorAll('.subject-select').forEach(select => {
                    select.innerHTML = '';
                    data.forEach(sub => {
                        const opt = document.createElement('option');
                        opt.value = sub.id;
                        opt.textContent = sub.name;
                        select.appendChild(opt);
                    });
                });
            });
    });
</script>
{% endif %}
{% endblock %}
