{% extends "base.html" %}

{% block title %}Manual Attendance{% endblock %}

{% block content %}
<h2 class="section-title">Manual Attendance Entry</h2>

<form method="GET" class="attendance-controls" style="margin-bottom: 2rem;">
    <div class="form-group">
        <label>Select Class First</label>
        <select name="class_name" onchange="this.form.submit()">
            <option value="">-- Choose --</option>
            <option value="FY" {{ 'selected' if class_name=='FY' else '' }}>FY</option>
            <option value="SY" {{ 'selected' if class_name=='SY' else '' }}>SY</option>
            <option value="TY" {{ 'selected' if class_name=='TY' else '' }}>TY</option>
        </select>
    </div>
</form>

{% if class_name %}
<div class="card">
    <h3>Mark Attendance for {{ class_name }}</h3>
    <table class="data-table">
        <thead>
            <tr>
                <th>Student</th>
                <th>Subject</th>
                <th>Status</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for student in students %}
            <tr>
                <td>
                    <strong>{{ student.name }}</strong><br>
                    <small>{{ student.enrollment_number }}</small>
                </td>
                <form method="POST" action="{{ url_for('manual_attendance') }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="class_name" value="{{ class_name }}">
                    <input type="hidden" name="student_id" value="{{ student.student_id }}">
                    <td>
                        <select name="subject_id" class="subject-select" required
                            style="padding: 0.5rem; border-radius: 4px; border:1px solid #ddd;">
                            <!-- Loaded via JS -->
                            <option>Loading...</option>
                        </select>
                    </td>
                    <td>
                        <select name="status" style="padding: 0.5rem; border-radius: 4px; border:1px solid #ddd;">
                            <option value="Present">Present</option>
                            <option value="Absent">Absent</option>
                            <option value="Late">Late</option>
                        </select>
                    </td>
                    <td>
                        <button type="submit" class="btn btn-primary"
                            style="padding: 0.5rem 1rem; width: auto;">Mark</button>
                    </td>
                </form>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
    // Load subjects for all dropdowns
    document.addEventListener('DOMContentLoaded', function () {
        fetch('/api/get_subjects/{{ class_name }}')
            .then(res => res.json())
            .then(data => {
                document.querySelectorAll('.subject-select').forEach(select => {
                    select.innerHTML = '';
                    data.forEach(sub => {
                        const opt = document.createElement('option');
                        opt.value = sub.id;
                        opt.textContent = sub.name;
                        select.appendChild(opt);
                    });
                });
            });
    });
</script>
{% endif %}
{% endblock %}
